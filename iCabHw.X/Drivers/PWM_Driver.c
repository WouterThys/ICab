#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <xc.h>

#include "PWM_Driver.h"

/*******************************************************************************
 *          DEFINES
 ******************************************************************************/


/*******************************************************************************
 *          MACRO FUNCTIONS
 ******************************************************************************/


/*******************************************************************************
 *          VARIABLES
 ******************************************************************************/


/*******************************************************************************
 *          BASIC FUNCTIONS
 ******************************************************************************/


/*******************************************************************************
 *          DRIVER FUNCTIONS
 ******************************************************************************/
void D_PWM_Init() {
    
    // Timer 2 
    PR2 = 0xFF;
    T2CONbits.TMR2ON = 0;
    T2CONbits.T2CKPS = 0b01; // Pre-scaler 4
    T2CONbits.TOUTPS = 0; // No post scale
    
    // Duty cycle
    CCPR1L = 0x1F;
    CCP1CONbits.DC1B = 0b00;
}

void D_PWM_SetPwm(uint8_t pwm) {
    if (pwm > 0) {
        if (T2CONbits.TMR2ON == 0) {
            CCP1CONbits.CCP1M = 0b1100; // PWM mode
            T2CONbits.TMR2ON = 1;
        }
        CCPR1L = pwm;
    } else {
        CCP1CONbits.CCP1M = 0b0000; // CCP1 off
        T2CONbits.TMR2ON = 0;
        PORTCbits.RC2 = 0;
    }
}
